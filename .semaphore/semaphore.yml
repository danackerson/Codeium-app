version: v1.0
name: Node.js CI Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Setup and Test"
    task:
      env_vars:
        - name: NODE_VERSION
          value: "14.x"
      prologue:
        commands:
          # Install Node.js
          - sudo apt-get update && sudo apt-get install -y curl
          - curl -sL https://deb.nodesource.com/setup_${NODE_VERSION} | sudo -E bash -
          - sudo apt-get install -y nodejs
          - node --version
          - npm --version

          # Install project dependencies
          - npm install

      jobs:
        - name: "Run and Test Application"
          commands:
            # Start the service in the background
            - node app.js &
            # Wait for the server to start up properly
            - sleep 5  # Adjust this based on your server's startup time

            # Test the service by querying the / route
            - curl -s http://localhost:3000/  # Ensure your app is set to use the right port

            # Optionally, check the output or status code here if needed